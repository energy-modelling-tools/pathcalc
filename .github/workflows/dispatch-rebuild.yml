name: Rebuild on template update

on:
  repository_dispatch:
    types: [page-template-updated]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger GitHub Pages build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/pages/builds"
          http_code=$(curl -s -o /tmp/resp.txt -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$api")
          if [ "$http_code" -ge 300 ]; then
            echo "Trigger failed (HTTP $http_code):" >&2
            cat /tmp/resp.txt >&2
            exit 1
          fi
          echo "Pages build triggered."
